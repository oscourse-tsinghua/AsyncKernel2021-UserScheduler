## 协程一定比线程快吗

否。

考虑这样一种情况，多线程环境下，分别将每个线程单独作为一个线程和协程。相比于线程版本，协程版本在进行切换时，需要多加入一个判断--下一个协程是否与当前协程位于同一线程中，即，是否引起线程切换。由于每个线程只有一个子线程或协程，切换时必然是线程切换，在这种情况下，协程将更慢。

考虑这样一种情况，多线程环境下，分别将每个线程单独作为一个线程和协程。相比于线程版本，协程版本在进行切换时，需要多加入一个判断--下一个协程是否与当前协程位于同一线程中，即，是否引起线程切换。由于每个线程只有一个子线程或协程，切换时必然是线程切换，在这种情况下，协程将更慢。

## 20210703

### 结果分析

- 数据量大小: sor1.txt --1.04G, sort2.txt --1.44G。
- 对于执行结果比较稳定的情况，使用 0.97-1.17 表示；不稳定的情况使用三行数字表示，第一行为最好情况，第三行为最坏情况，中间一行为出现次数最多的情况。
- 从实际执行结果来看，并不是读的块越大，读文件的性能就越好，单次读到达64M后，多协程读和单线程读的速度都开始下降。
- 协程的个数与CPU的个数之间的关系，对程序执行速度有很大影响 10% - 15%。这其中或许存在一个最佳的关系。

#### 单线程读文件 

- 线程1读 sort1.txt，线程2读 sort2.txt。
- 当每次读取的数据量 buffer = 1MB 时达到最佳性能，此后增大buffer性能将不断下降。
- 相比于多协程读，单线程读文件的执行速度更能稳定在一个较小区间内。

#### 多协程读文件

- 线程1每次生成3个协程读 sort1.txt,线程2内每次生成9个协程读 sort2.txt。（经测试，3 + 9的组合下，执行速度最快）。
- 当 buffer >= 16MB 时，性能超过单线程读文件
- buffer大小无论在任何情况下都无法超过单线程读文件的最好情况（buffer = 1MB时的 0.58-0.59）。


| 每次读大小<br>(单位: B) | 多协程封装多线程     | 单线程无协程         |      |      |
| :---------------------- | :------------------- | :------------------- | :--- | :--- |
| 512k                    | 0.97-1.17            | 0.69<br>0.82<br>0.90 |      |      |
| 1024k(1m)               | 0.67<br>0.8<br>0.85  | 0.58-0.59            |      |      |
| 4096k(4m)               | 0.81<br>0.85<br>0.94 | 0.75-0.77            |      |      |
| 8m                      | 0.85-0.88            | 0.83-0.86            |      |      |
| 12m                     | 0.80<br>0.87<br>0.91 | 0.86-0.87            |      |      |
| 16m                     | 0.78<br>0.88<br>0.90 | 0.90-0.93            |      |      |
| 24m                     | 0.80<br>0.89<br>0.90 | 0.98-1.01            |      |      |
| 32m                     | 0.85<br>0.90<br>0.94 | 0.99-1.02            |      |      |
| 36m                     | 0.83<br>0.91<br>0.96 | 0.99-1.00            |      |      |
| 40m                     | 0.82<br>0.90<br>0.95 | 0.99-1.00            |      |      |
| 44m                     | 0.84<br>0.91<br>0.99 | 0.99-1.00            |      |      |
| 48m                     | 0.84<br>0.91<br>0.96 | 0.99-1.00            |      |      |



## 20210707

最底层的读文件线程在读取一个buffer之后，需要将结果传递给上层线程，这个结果作为函数参数传入线程。原先的做法是将读出的结果赋值给此参数，现在将此参数改为一个指针，取出读出的结果指针进行赋值，使得效率显著提升。

在多协程读中，一次性生成所有读线程，虽然CPU数量有限，但在未读完时可以使CPU一直满载，相比于多次生成少量读线程，提高了吞吐率。

|                        | 多协程读                             | 无协程读 |
| ---------------------- | ------------------------------------ | -------- |
| 读buffer大小           | 1MB                                  | 1MB      |
| 程序总体完成时间       | 0.21S                                | 0.35S    |
| 完成一次读操作所需时间 | 最开始为0.002S，然后为0.0003-0.0008S | 0.0002S  |

多协程读，完成一次读操作的时间更慢，是因为每个读线程都需要打开文件并设置读的位置。且虽然改进了读出结果向上层传递的做法，但这个操作依然比不需要传递的情况更耗时。
